<% content_for :head do %>
  <meta name="turbo-cache-control" content="no-cache">
<% end %>

<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  <div class="mb-10">
    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Settings</h1>
    <p class="mt-2 text-lg text-gray-600">Manage your repository connections and preferences.</p>
  </div>

  <div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-gray-100">
    <div class="px-6 py-8 border-b border-gray-100 bg-gray-50/50">
      <h2 class="text-xl font-semibold text-gray-900">Repository Connections</h2>
      <p class="mt-1 text-sm text-gray-500">Connect your accounts to sync pull requests. Tokens are encrypted and stored securely.</p>
    </div>

    <div class="divide-y divide-gray-100">
      <% @providers.each do |provider| %>
        <% connection = @connections[provider] %>
        <div class="p-6 sm:p-8 hover:bg-gray-50/30 transition-colors duration-200">
          <div class="flex items-start justify-between">
            <div class="flex items-center space-x-4">
              <div class="flex-shrink-0 p-2 bg-gray-50 rounded-lg border border-gray-100">
                <% case provider %>
                <% when 'github' %>
                  <svg class="h-8 w-8 text-gray-900" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd" /></svg>
                <% when 'gitlab' %>
                  <svg class="h-8 w-8 text-orange-600" fill="currentColor" viewBox="0 0 24 24"><path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51A.42.42 0 0 1 4.82 2a.43.43 0 0 1 .41.26l2.47 7.6h8.6l2.47-7.6a.43.43 0 0 1 .41-.26.42.42 0 0 1 .11.02l2.44 7.51 1.22 3.78a.84.84 0 0 1-.3.94z"/></svg>
                <% when 'bitbucket' %>
                  <svg class="h-8 w-8 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M2.65 3C2.05 3 1.55 3.5 1.6 4.1L2.7 20.4C2.75 21.3 3.5 22 4.4 22H19.6C20.5 22 21.25 21.3 21.3 20.4L22.4 4.1C22.45 3.5 21.95 3 21.35 3H2.65ZM13.8 15.4H10.2L9.4 9.6H14.6L13.8 15.4Z" /></svg>
                <% end %>
              </div>
              <div>
                <h3 class="text-lg font-bold text-gray-900 capitalize"><%= provider.titleize %></h3>
                <div class="mt-1 flex items-center gap-2">
                  <% is_connected = connection&.connected == true %>
                  <span id="status-<%= provider %>" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= is_connected ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-gray-100 text-gray-600 border border-gray-200' %>">
                    <svg class="-ml-0.5 mr-1.5 h-2 w-2 <%= is_connected ? 'text-green-500' : 'text-gray-400' %>" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3" /></svg>
                    <span id="status-text-<%= provider %>"><%= is_connected ? 'Connected' : 'Not Connected' %></span>
                  </span>
                  
                  <% if connection %>
                    <button type="button" 
                            onclick="testConnection('<%= provider %>')"
                            id="test-btn-<%= provider %>"
                            class="text-xs text-indigo-600 hover:text-indigo-800 font-medium transition-colors">
                      Test Connection
                    </button>
                  <% end %>
                </div>
              </div>
            </div>
            
            <% if connection %>
              <%= link_to settings_update_path(provider: provider, access_token: ""), data: { turbo_method: :post, turbo_confirm: "Are you sure you want to disconnect #{provider.titleize}?" }, class: "group flex items-center text-sm text-gray-400 hover:text-red-600 transition-colors duration-200" do %>
                <span class="mr-2 group-hover:underline">Disconnect</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
              <% end %>
            <% end %>
          </div>

          <div class="mt-6 max-w-3xl space-y-4">
             <%= form_with url: settings_update_path, method: :post, local: true, class: "relative space-y-4" do |f| %>
                <%= f.hidden_field :provider, value: provider %>
                
                <% if provider == 'bitbucket' %>
                  <div class="space-y-3">
                    <div>
                      <label class="block text-xs font-medium text-gray-700 mb-1">Bitbucket Username</label>
                      <%= f.text_field :username, value: connection&.username, placeholder: "your-username", class: "block w-full border border-gray-300 rounded-md py-2 px-3 text-gray-900 placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-gray-700 mb-1">Workspace (optional)</label>
                      <%= f.text_field :workspace, value: connection&.workspace, placeholder: "your-workspace", class: "block w-full border border-gray-300 rounded-md py-2 px-3 text-gray-900 placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
                    </div>
                  </div>
                <% end %>
                
                <div class="flex rounded-md shadow-sm ring-1 ring-gray-300 focus-within:ring-2 focus-within:ring-indigo-500 bg-white overflow-hidden transition-shadow duration-200">
                   <div class="flex-grow relative">
                      <% 
                        begin
                          token_value = connection&.access_token
                        rescue ActiveRecord::Encryption::Errors::Decryption
                          token_value = nil
                        end
                      %>
                      <%= f.password_field :access_token, value: token_value, placeholder: "Paste your Personal Access Token", class: "block w-full border-0 py-3 pl-4 pr-10 text-gray-900 placeholder-gray-400 focus:ring-0 sm:text-sm" %>
                   </div>
                   <%= f.submit "Save", class: "cursor-pointer inline-flex items-center px-6 py-3 border-l border-gray-200 bg-gray-50 text-gray-700 font-medium text-sm hover:bg-indigo-600 hover:text-white focus:outline-none focus:ring-0 transition-all duration-200" %>
                </div>
             <% end %>
          </div>

          <div class="mt-4">
            <details class="group text-sm">
              <summary class="cursor-pointer text-indigo-600 hover:text-indigo-800 font-medium flex items-center w-fit select-none transition-colors">
                <svg class="h-4 w-4 mr-1 transition-transform duration-200 group-open:rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                How to get a token?
              </summary>
              <div class="mt-3 pl-5 text-gray-600 space-y-2 border-l-2 border-indigo-100 ml-2 animate-fadeIn">
                <% case provider %>
                <% when 'github' %>
                  <p>1. Go to <a href="https://github.com/settings/tokens" target="_blank" class="text-indigo-600 hover:underline font-medium">GitHub Settings > Developer settings > Personal access tokens</a>.</p>
                  <p>2. Click <strong>Generate new token (classic)</strong>.</p>
                  <p>3. Select the <code class="bg-gray-100 px-1 py-0.5 rounded text-xs font-mono text-gray-800">repo</code> scope (Full control of private repositories).</p>
                  <p>4. Generate and copy the token.</p>
                <% when 'gitlab' %>
                  <p>1. Go to <a href="https://gitlab.com/-/profile/personal_access_tokens" target="_blank" class="text-indigo-600 hover:underline font-medium">User Settings > Access Tokens</a>.</p>
                  <p>2. Enter a name and expiry date.</p>
                  <p>3. Select the <code class="bg-gray-100 px-1 py-0.5 rounded text-xs font-mono text-gray-800">read_api</code> scope.</p>
                  <p>4. Create and copy the token.</p>
                <% when 'bitbucket' %>
                  <p>1. Go to <a href="https://bitbucket.org/account/settings/app-passwords/" target="_blank" class="text-indigo-600 hover:underline font-medium">Personal settings > App passwords</a>.</p>
                  <p>2. Click <strong>Create app password</strong>.</p>
                  <p>3. Select the <code class="bg-gray-100 px-1 py-0.5 rounded text-xs font-mono text-gray-800">Pull requests: Read</code> permission.</p>
                  <p>4. Create and copy the password.</p>
                <% end %>
              </div>
            </details>
          </div>

        </div>
      <% end %>
    </div>
    <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-between items-center">
       <span class="text-xs text-gray-400">Tokens are encrypted at rest.</span>
       <%= link_to "Back to Dashboard", root_path, class: "text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors" %>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div id="error-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeErrorModal()"></div>

    <!-- Modal panel -->
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="sm:flex sm:items-start">
          <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
            <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left flex-1">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
              Connection Test Failed
            </h3>
            <div class="mt-2">
              <p class="text-sm text-gray-500 mb-2">
                Failed to connect to <span id="error-provider" class="font-semibold"></span>
              </p>
              <div class="mt-3 bg-red-50 border border-red-200 rounded-md p-3">
                <p class="text-sm font-mono text-red-800" id="error-message"></p>
              </div>
              <div class="mt-4">
                <p class="text-xs text-gray-600">
                  <strong>Troubleshooting tips:</strong>
                </p>
                <ul class="mt-2 text-xs text-gray-600 list-disc list-inside space-y-1">
                  <li>Verify your Personal Access Token is correct</li>
                  <li>Check that the token has the required permissions</li>
                  <li>For Bitbucket: Ensure username and workspace are correct</li>
                  <li>Check your internet connection</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button type="button" onclick="closeErrorModal()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
function testConnection(provider) {
  const btn = document.getElementById(`test-btn-${provider}`);
  const statusBadge = document.getElementById(`status-${provider}`);
  const statusText = document.getElementById(`status-text-${provider}`);
  
  // Disable button and show loading state
  btn.disabled = true;
  btn.textContent = 'Testing...';
  
  // Get CSRF token
  const token = document.querySelector('meta[name="csrf-token"]').content;
  
  fetch('/settings/test_connection', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': token,
      'Accept': 'application/json'
    },
    body: JSON.stringify({ provider: provider })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update status to connected
      statusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200';
      statusBadge.querySelector('svg').className = '-ml-0.5 mr-1.5 h-2 w-2 text-green-500';
      statusText.textContent = 'Connected';
      
      // Show success message
      showNotification(data.message, 'success');
    } else {
      // Update status to error
      statusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200';
      statusBadge.querySelector('svg').className = '-ml-0.5 mr-1.5 h-2 w-2 text-red-500';
      statusText.textContent = 'Error';
      
      // Show error modal with details
      showErrorModal(provider, data.error || data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showErrorModal(provider, 'Connection test failed. Please try again.');
  })
  .finally(() => {
    // Re-enable button
    btn.disabled = false;
    btn.textContent = 'Test Connection';
  });
}

function showNotification(message, type) {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg ${
    type === 'success' ? 'bg-green-500' : 'bg-red-500'
  } text-white max-w-md animate-slide-in`;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  // Remove after 5 seconds
  setTimeout(() => {
    notification.classList.add('animate-slide-out');
    setTimeout(() => notification.remove(), 300);
  }, 5000);
}

function showErrorModal(provider, errorMessage) {
  const modal = document.getElementById('error-modal');
  const providerSpan = document.getElementById('error-provider');
  const errorMessageP = document.getElementById('error-message');
  
  providerSpan.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
  errorMessageP.textContent = errorMessage;
  
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closeErrorModal() {
  const modal = document.getElementById('error-modal');
  modal.classList.add('hidden');
  document.body.style.overflow = ''; // Restore scrolling
}
</script>

<style>
@keyframes slide-in {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slide-out {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(100%);
    opacity: 0;
  }
}

.animate-slide-in {
  animation: slide-in 0.3s ease-out;
}

.animate-slide-out {
  animation: slide-out 0.3s ease-in;
}
</style>
